name: Trae windows

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Trae
        run: |
          curl -o Trae.dmg https://lf-cdn.trae.ai/obj/trae-ai-us/pkg/app/releases/stable/1.0.5760/darwin/Trae-darwin-arm64.dmg
          # se necesita mejora en esto 

      - name: Extract dmg
        run: |
          mkdir extracted
          7z x -snl Trae.dmg -oextracted || echo "asd"
          move extracted\Trae\Trae.app\Contents contents
        continue-on-error: true

      - name: Download new dependencies
        run: |
          curl -o dependencias.zip https://beaches-assure-seemed-christine.trycloudflare.com/dependencias.zip
          7z x dependencias.zip -o"contents\Resources\app\node_modules" -y

      - name: Install Electron (globally)
        run: |
          npm install -g electron
          # se deber√≠a de mejorar esto, pero actualmente, funciona

      - name: Copy Electron to local node_modules
        run: |
          xcopy /E /I "$(npm root -g)\\electron" contents\Resources\app\node_modules\electron
    
      - name: symlinks deleted
        run: |
          Remove-Item -Recurse -Force contents\Resources\app\modules\ai-completion\usr\bin\ide-aiserver

      - name: Package Trae
        run: |
          cd contents\Resources\app
          npx electron-packager . Trae --platform=win32 --arch=x64 --out=dist --overwrite --no-prune

      - name: zip dist
        run: |
          cd contents\Resources\app\dist
          7z a Trae-win32-x64.zip Trae-win32-x64

      - name: Upload executable artifact
        uses: actions/upload-artifact@v3
        with:
          name: Trae-Windows-Executable
          path: contents\Resources\app\dist\Trae-win32-x64.zip

  installer:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: Trae-Windows-Executable

      - name: Extract the outer zip
        run: |
          mkdir extracted
          7z x Trae-Windows-Executable.zip -oextracted

      - name: Extract the inner zip
        run: |
          mkdir extracted_inner
          7z x extracted/Trae-win32-x64.zip -oextracted_inner

      - name: Download inno setup script
        run: |
          curl -o setup.iss https://beaches-assure-seemed-christine.trycloudflare.com/setup.iss

      - name: Install inno setup
        run: |
          choco install innosetup --yes

      - name: Create installer
        run: |
          Start-Process -FilePath "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" -ArgumentList "setup.iss" -Wait

      - name: Upload installer artifact
        uses: actions/upload-artifact@v3
        with:
          name: Trae-Windows-Installer
          path: "**/*.exe"
